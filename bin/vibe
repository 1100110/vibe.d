#!/bin/sh
set -e
VIBEBINARY=$(readlink "$0")
if [ ! -n "$VIBEBINARY" ]; then VIBEBINARY="$0"; fi
VIBEPATH=$(dirname "$VIBEBINARY")

#use pkg-config or fallback to default flags
LIBS=$(pkg-config --libs libevent libevent_pthreads libssl 2>/dev/null || echo "-levent_pthreads -levent -lssl -lcrypto")
LIBS=$(echo "$LIBS" | sed 's/^-L/-L-L/; s/ -L/ -L-L/g; s/^-l/-L-l/; s/ -l/ -L-l/g')
export LIBS

START_SCRIPT=`mktemp -t vpm.start.XXXXXXXX`
cp -p "$VIBEPATH"/vpm.d /tmp/vpm.d
chmod 666 /tmp/vpm.d

rdmd -g -w -property -I"$VIBEPATH"/../source $LIBS -Jviews -Isource /tmp/vpm.d "$VIBEPATH" "$START_SCRIPT" $1 $2 $3 $4 $5 $6 $7 $8 $9

if [ $? = 0 ]
then
	chmod +x "$START_SCRIPT"
	"$START_SCRIPT"
	rm "$START_SCRIPT"
fi
